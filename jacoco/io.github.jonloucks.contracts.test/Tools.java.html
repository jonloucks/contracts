<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Tools.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">contracts</a> &gt; <a href="index.source.html" class="el_package">io.github.jonloucks.contracts.test</a> &gt; <span class="el_source">Tools.java</span></div><h1>Tools.java</h1><pre class="source lang-java linenums">package io.github.jonloucks.contracts.test;

import io.github.jonloucks.contracts.api.*;
import org.junit.jupiter.api.function.Executable;

import java.io.Serializable;
import java.lang.reflect.*;
import java.time.Duration;
import java.util.ServiceLoader;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;
import java.util.function.Consumer;

import static io.github.jonloucks.contracts.api.Checks.*;
import static java.lang.Character.isUpperCase;
import static java.util.Optional.ofNullable;
import static org.junit.jupiter.api.Assertions.*;

/**
 * Contracts testing tools
 */
@SuppressWarnings(&quot;DataFlowIssue&quot;)
public final class Tools {
<span class="fc" id="L24">    private Tools() {</span>
<span class="fc" id="L25">        throw new AssertionError(&quot;Illegal constructor call&quot;);</span>
    }
    
    public static void assertFails(Executable executable) {
<span class="fc" id="L29">        final Executable validExecutable = nullCheck(executable, &quot;Executable must be present.&quot;);</span>
<span class="fc" id="L30">        final AssertionError thrown = assertThrows(AssertionError.class, validExecutable);</span>
<span class="fc" id="L31">        assertObject(thrown);</span>
<span class="fc" id="L32">        assertNotNull(thrown.getMessage());</span>
<span class="fc" id="L33">    }</span>
    /**
     * Assert that an object complies with basic expectations
     * @param object the object to check
     */
    public static void assertObject(Object object) {
<span class="fc" id="L39">        final class Unknown {}</span>
<span class="fc" id="L40">        final Unknown unknown = new Unknown();</span>
        
<span class="fc" id="L42">        assertNotNull(object, &quot;object was null.&quot;);</span>
        
        //noinspection SimplifiableAssertion,ConstantValue
<span class="fc" id="L45">        assertAll(</span>
<span class="fc" id="L46">            () -&gt; assertEquals(object.hashCode(), object.hashCode(), &quot;Hash codes should not change.&quot;),</span>
<span class="fc" id="L47">            () -&gt; assertNotNull(object.toString(), &quot;Object toString() was null.&quot;),</span>
<span class="fc" id="L48">            () -&gt; assertFalse(object.equals(null), &quot;Object.equals(null) should be false.&quot;),</span>
<span class="fc" id="L49">            () -&gt; assertFalse(object.equals(unknown), &quot;Object.equals(unknown) should be false.&quot;)</span>
        );
<span class="fc" id="L51">    }</span>
    
    /**
     * Asserts that a class can NOT be instantiated
     *
     * @param theClass the class to check
     */
    public static void assertInstantiateThrows(Class&lt;?&gt; theClass) {
<span class="fc" id="L59">        final Class&lt;?&gt; validClass = typeCheck(theClass);</span>
<span class="fc" id="L60">        final Throwable thrown = assertThrows(Throwable.class, () -&gt; {</span>
<span class="fc" id="L61">            final Constructor&lt;?&gt; constructor = validClass.getDeclaredConstructor();</span>
<span class="fc" id="L62">            constructor.setAccessible(true);</span>
<span class="fc" id="L63">            constructor.newInstance();</span>
<span class="fc" id="L64">        });</span>
    
<span class="pc bpc" id="L66" title="4 of 10 branches missed.">        assertTrue(thrown instanceof IllegalAccessException ||</span>
            thrown instanceof InaccessibleObjectException ||
            thrown instanceof InvocationTargetException ||
            thrown instanceof NoSuchMethodException ||
            thrown instanceof AssertionError
<span class="fc" id="L71">            , &quot;Exception thrown not expected &quot; + thrown.getClass().getName());</span>
<span class="fc" id="L72">    }</span>
    
    public static void assertThrown(Throwable thrown, Throwable cause, String reason) {
<span class="fc" id="L75">        assertObject(thrown);</span>
        
<span class="fc" id="L77">        assertAll(</span>
<span class="fc" id="L78">            () -&gt; assertMessage(thrown.getMessage()),</span>
<span class="fc" id="L79">            () -&gt; assertEquals(cause, thrown.getCause(), &quot;The cause should match.&quot;),</span>
<span class="fc" id="L80">            () -&gt; assertEquals(reason, thrown.getMessage(), &quot;The reason should match.&quot;),</span>
<span class="fc" id="L81">            () -&gt; assertNotNull(thrown.toString(), &quot;The string should not be null.&quot;)</span>
        );
<span class="fc" id="L83">    }</span>
    
    public static void assertMessage(String message) {
<span class="fc" id="L86">        assertNotNull(message, &quot;Message must be present.&quot;);</span>
<span class="fc" id="L87">        assertFalse(message.isEmpty(), &quot;Message should not be empty.&quot;);</span>
<span class="fc" id="L88">        assertTrue(isUpperCase(message.charAt(0)), &quot;Message should start with a upper case character.&quot;);</span>
<span class="fc" id="L89">        assertEquals('.', message.charAt(message.length()-1), &quot;Message should end with a dot: &quot; + message + &quot;.&quot;);</span>
<span class="fc" id="L90">    }</span>
    
    public static void assertThrown(Throwable thrown) {
<span class="fc" id="L93">        assertNotNull(thrown, &quot;Thrown must be present.&quot;);</span>
        
<span class="fc" id="L95">        assertThrown(thrown, thrown.getCause(), thrown.getMessage());</span>
<span class="fc" id="L96">    }</span>
    
    public static void assertThrown(Throwable thrown, Throwable cause) {
<span class="fc" id="L99">        assertNotNull(thrown, &quot;Thrown must be present.&quot;);</span>
        
<span class="fc" id="L101">        assertThrown(thrown, cause, thrown.getMessage());</span>
<span class="fc" id="L102">    }</span>
    
    public static void assertThrown(Throwable thrown, String reason) {
<span class="fc" id="L105">        assertNotNull(thrown, &quot;Thrown must be present.&quot;);</span>
        
<span class="fc" id="L107">        assertThrown(thrown, thrown.getCause(), reason);</span>
<span class="fc" id="L108">    }</span>
  
    /**
     * Assert a Contract is valid
     * @param contract the contract to check
     * @param config the expected configuration
     * @param valid  a valid value
     * @param &lt;T&gt; the type of deliverable
     */
    public static &lt;T&gt; void assertContract(Contract&lt;T&gt; contract, Contract.Config&lt;T&gt; config, T valid) {
<span class="fc" id="L118">        assertNotNull(contract, &quot;Contract must not be null.&quot;);</span>

<span class="fc" id="L120">        assertAll(</span>
<span class="fc" id="L121">            () -&gt; assertObject(contract),</span>
<span class="fc" id="L122">            () -&gt; assertSame(config.cast(valid),contract.cast(valid), &quot;Casting a valid value should work.&quot;),</span>
<span class="fc" id="L123">            () -&gt; assertNull(contract.cast(null), &quot;Casting null should return null.&quot;),</span>
<span class="pc" id="L124">            () -&gt; assertThrows(ClassCastException.class, () -&gt; contract.cast(System.class), &quot;Invalid cast should thrown.&quot;),</span>
<span class="fc" id="L125">            () -&gt; assertSame(config.typeName(), contract.getTypeName(), &quot;Contract type mismatch.&quot;),</span>
<span class="fc" id="L126">            () -&gt; assertSame(config.name(), contract.getName(), &quot;Contract name mismatch.&quot;),</span>
<span class="fc" id="L127">            () -&gt; assertSame(config.isReplaceable(), contract.isReplaceable(), &quot;Contract replacement mismatch.&quot;)</span>
        );
<span class="fc" id="L129">    }</span>
    
    /**
     * When cleaning before and after tests.
     * The strategy is to execute all sanitizers, ignoring any errors.
     * @param sanitizers the things to sanitize
     */
    public static void sanitize(Executable... sanitizers) {
<span class="fc bfc" id="L137" title="All 2 branches covered.">        if(ofNullable(sanitizers).isPresent()) {</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">            for (Executable sanitizer : sanitizers) {</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">                if (ofNullable(sanitizer).isPresent()) {</span>
                    try {
<span class="fc" id="L141">                        sanitizer.execute();</span>
<span class="fc" id="L142">                    } catch (Throwable ignored) {</span>
<span class="fc" id="L143">                    }</span>
                }
            }
        }
<span class="fc" id="L147">    }</span>
    
    /**
     * Clean state from the testing context.
     */
    public static void clean() {
<span class="fc" id="L153">        sanitize(()-&gt; {</span>
<span class="fc" id="L154">            final Contracts.Config config = new Contracts.Config() {};</span>
<span class="nc" id="L155">            final ServiceLoader&lt;? extends ContractsFactory&gt; loader = ServiceLoader.load(config.serviceLoaderClass());</span>
<span class="nc" id="L156">            loader.reload();</span>
<span class="nc" id="L157">        });</span>
<span class="fc" id="L158">    }</span>
    
    /**
     * Do nothing for a period of time (Non-busy-wait)
     * @param duration how long to sleep
     */
    public static void sleep(Duration duration) {
<span class="fc" id="L165">        final Duration validDuration = nullCheck(duration, &quot;Duration must be present.&quot;);</span>
<span class="fc" id="L166">        final CountDownLatch latch = new CountDownLatch(1);</span>
        
<span class="fc" id="L168">        illegalCheck(validDuration, validDuration.isNegative(), &quot;Duration must not be negative.&quot;);</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (validDuration.isZero()) {</span>
<span class="fc" id="L170">            return;</span>
        }
        
        try {
<span class="fc" id="L174">            assertFalse(latch.await(validDuration.toMillis(), TimeUnit.MILLISECONDS));</span>
<span class="nc" id="L175">        } catch (InterruptedException ignored) {</span>
<span class="fc" id="L176">        }</span>
<span class="fc" id="L177">    }</span>
    
    public static &lt;T&gt; Contract&lt;T&gt; createReplaceableContract(Class&lt;T&gt; type) {
<span class="fc" id="L180">        return Contract.create(new Contract.Config&lt;&gt;() {</span>
            @Override
            public T cast(Object instance) {
<span class="fc" id="L183">                return type.cast(instance);</span>
            }
            @Override
            public boolean isReplaceable() {
<span class="fc" id="L187">                return true;</span>
            }
        });
    }

    public static void assertIsSerializable(Class&lt;?&gt; clazz) {
<span class="fc" id="L193">        assertTrue(Serializable.class.isAssignableFrom(clazz), &quot;Class must implement Serializable.&quot;);</span>
        try {
<span class="fc" id="L195">            final Field serialVersionUIDField = clazz.getDeclaredField(&quot;serialVersionUID&quot;);</span>
<span class="fc" id="L196">            assertNotNull(serialVersionUIDField, &quot;The serialVersionUID field must exist.&quot;);</span>
<span class="fc" id="L197">            assertTrue(Modifier.isStatic(serialVersionUIDField.getModifiers()), &quot;The serialVersionUID must be static.&quot;);</span>
<span class="fc" id="L198">            assertTrue(Modifier.isFinal(serialVersionUIDField.getModifiers()), &quot;The serialVersionUID must be final.&quot;);</span>
<span class="fc" id="L199">            assertEquals(long.class, serialVersionUIDField.getType(), &quot;The serialVersionUID must be of type long.&quot;);</span>
<span class="nc" id="L200">        }  catch (NoSuchFieldException ignored) {</span>
<span class="nc" id="L201">            fail(&quot;Unable to find serialVersionUID field in class &quot; + clazz.getName() + &quot;.&quot;);</span>
<span class="fc" id="L202">        }</span>
<span class="fc" id="L203">    }</span>
    
    public static void withContracts(Consumer&lt;Contracts&gt; block) {
<span class="fc" id="L206">        final Contracts.Config config = new Contracts.Config() {</span>
            @Override
            public boolean useShutdownHooks() {
<span class="fc" id="L209">                return false;</span>
            }
        };
<span class="fc" id="L212">        withContracts(config, block);</span>
<span class="fc" id="L213">    }</span>
    
    public static void withContracts(Contracts.Config config, Consumer&lt;Contracts&gt; block) {
<span class="fc" id="L216">        final Contracts.Config validConfig = configCheck(config);</span>
<span class="fc" id="L217">        final Consumer&lt;Contracts&gt; validBlock = nullCheck(block, &quot;Block must be present.&quot;);</span>
<span class="fc" id="L218">        final Contracts contracts = GlobalContracts.createContracts(validConfig);</span>
        
<span class="fc" id="L220">        try (AutoClose closeContracts = contracts.open()) {</span>
<span class="fc" id="L221">            final AutoClose ignored = closeContracts;</span>
<span class="fc" id="L222">            validBlock.accept(contracts);</span>
        }
<span class="fc" id="L224">    }</span>
    
    public static void implicitClose(AutoClose close) {
<span class="fc" id="L227">        close.close();</span>
<span class="fc" id="L228">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>