<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LifeCyclePromisorTests.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">contracts</a> &gt; <a href="index.source.html" class="el_package">io.github.jonloucks.contracts.test</a> &gt; <span class="el_source">LifeCyclePromisorTests.java</span></div><h1>LifeCyclePromisorTests.java</h1><pre class="source lang-java linenums">package io.github.jonloucks.contracts.test;

import io.github.jonloucks.contracts.api.*;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;
import org.mockito.stubbing.Answer;

import java.time.Duration;
import java.util.concurrent.*;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.function.Supplier;

import static io.github.jonloucks.contracts.test.LifeCyclePromisorTests.ConcurrencyTestsTool.*;
import static io.github.jonloucks.contracts.test.Tools.*;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@SuppressWarnings({&quot;Convert2MethodRef&quot;, &quot;CodeBlock2Expr&quot;})
@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT)
public interface LifeCyclePromisorTests {
    
    @Test
    default void lifeCyclePromisor_WithNullPromisor_Throws() {
<span class="fc" id="L31">        withContracts(contracts -&gt; {</span>
<span class="fc" id="L32">            final Promisors promisors = contracts.claim(Promisors.CONTRACT);</span>
            
<span class="fc" id="L34">            final IllegalArgumentException thrown = assertThrows(IllegalArgumentException.class, () -&gt;</span>
<span class="nc" id="L35">                promisors.createLifeCyclePromisor(null)</span>
            );
            
<span class="fc" id="L38">            assertThrown(thrown);</span>
<span class="fc" id="L39">        });</span>
<span class="fc" id="L40">    }</span>
    
    @Test
    default void lifeCyclePromisor_demand_WithoutUsage_Throws() {
<span class="fc" id="L44">        withContracts(contracts -&gt; {</span>
<span class="fc" id="L45">            final Promisors promisors = contracts.claim(Promisors.CONTRACT);</span>
<span class="pc" id="L46">            final Promisor&lt;String&gt; promisor = promisors.createLifeCyclePromisor(() -&gt; &quot;abc&quot;);</span>
            
<span class="fc" id="L48">            final IllegalStateException thrown = assertThrows(IllegalStateException.class, () -&gt; {</span>
<span class="nc" id="L49">                promisor.demand();</span>
<span class="nc" id="L50">            });</span>
            
<span class="fc" id="L52">            assertThrown(thrown);</span>
<span class="fc" id="L53">        });</span>
<span class="fc" id="L54">    }</span>
    
    @Test
    default void lifeCyclePromisor_WithNullDeliverable_IsAllowed() {
<span class="fc" id="L58">        withContracts(contracts -&gt; {</span>
<span class="fc" id="L59">            final Promisors promisors = contracts.claim(Promisors.CONTRACT);</span>
<span class="fc" id="L60">            final Promisor&lt;String&gt; promisor = promisors.createLifeCyclePromisor(()-&gt;null);</span>
<span class="fc" id="L61">            promisor.incrementUsage();</span>
            
<span class="fc" id="L63">            assertNotNull(promisor, &quot;should not return null.&quot;);</span>
<span class="fc" id="L64">            assertNull(promisor.demand());</span>
<span class="fc" id="L65">        });</span>
<span class="fc" id="L66">    }</span>
    
    @Test
    default void lifeCyclePromisor_Valid_Works(@Mock Promisor&lt;Decoy&lt;Integer&gt;&gt; referent, @Mock Decoy&lt;Integer&gt; deliverable) {
<span class="fc" id="L70">        withContracts(contracts -&gt; {</span>
<span class="fc" id="L71">            final int usages = 5;</span>
<span class="fc" id="L72">            final Promisors promisors = contracts.claim(Promisors.CONTRACT);</span>
<span class="fc" id="L73">            when(referent.demand()).thenReturn(deliverable);</span>
<span class="fc" id="L74">            when(deliverable.open()).thenReturn(deliverable);</span>
<span class="fc" id="L75">            final Promisor&lt;Decoy&lt;Integer&gt;&gt; promisor = promisors.createLifeCyclePromisor(referent);</span>
            
<span class="fc" id="L77">            assertNotNull(promisor, &quot;should not return null.&quot;);</span>
            
<span class="fc bfc" id="L79" title="All 2 branches covered.">            for (int i = 0; i &lt; usages; i++) {</span>
<span class="fc" id="L80">                promisor.incrementUsage();</span>
            }
<span class="fc" id="L82">            @SuppressWarnings(&quot;resource&quot;) final Decoy&lt;Integer&gt; actual = promisor.demand();</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">            for (int i = 0; i &lt; usages; i++) {</span>
<span class="fc" id="L84">                promisor.decrementUsage();</span>
            }
            
<span class="fc" id="L87">            assertAll(</span>
<span class="fc" id="L88">                () -&gt; assertSame(deliverable, actual, &quot;deliverables should match.&quot;),</span>
<span class="fc" id="L89">                () -&gt; verify(referent, times(usages)).decrementUsage(),</span>
<span class="fc" id="L90">                () -&gt; verify(referent, times(usages)).incrementUsage(),</span>
<span class="fc" id="L91">                () -&gt; verify(deliverable, never()).incrementUsage(),</span>
<span class="fc" id="L92">                () -&gt; verify(deliverable, never()).decrementUsage(),</span>
<span class="fc" id="L93">                () -&gt; verify(deliverable, times(1)).open(),</span>
<span class="fc" id="L94">                () -&gt; verify(deliverable, times(1)).close()</span>
            );
<span class="fc" id="L96">        });</span>
<span class="fc" id="L97">    }</span>
    
    @ParameterizedTest(name = &quot;Threads = {0}&quot;)
    @ValueSource(ints = { 1, 2, 3, 5, 8, 12, 17, 29 })
    default void lifeCyclePromisor_ClaimsDuringOpen(int threadCount) throws Throwable {
<span class="fc" id="L102">        runWithScenario(new ScenarioConfig() {</span>
            @Override
            public int threadCount() {
<span class="fc" id="L105">                return threadCount;</span>
            }
            @Override
            public void mockupDeliverable(Decoy&lt;String&gt; mockDeliverable) {
<span class="fc" id="L109">                overrideOpen(mockDeliverable, Duration.ofMillis(200), () -&gt; {});</span>
<span class="fc" id="L110">            }</span>
        });
<span class="fc" id="L112">    }</span>
    
    @ParameterizedTest(name = &quot;Threads = {0}&quot;)
    @ValueSource(ints = { 1, 2, 3, 5, 8, 12, 17, 29 })
    default void lifeCyclePromisor_ThrowingOpen(int threadCount) throws Throwable {
<span class="fc" id="L117">        runWithScenario(new ScenarioConfig() {</span>
            @Override
            public int threadCount() {
<span class="fc" id="L120">                return threadCount;</span>
            }
            @Override
            public float successPercentage() {
<span class="fc" id="L124">                return 0.f;</span>
            }
            @Override
            public void mockupDeliverable(Decoy&lt;String&gt; mockDeliverable) {
<span class="fc" id="L128">                overrideOpen(mockDeliverable, Duration.ofMillis(0), () -&gt; {</span>
<span class="pc bpc" id="L129" title="1 of 4 branches missed.">                    switch (threadCount%3) {</span>
                        case 0:
<span class="fc" id="L131">                            throw new RuntimeException(&quot;RuntimeException&quot;);</span>
                        case 1:
<span class="fc" id="L133">                            throw new Error(&quot;Error&quot;);</span>
                        case 2:
<span class="fc" id="L135">                            throw new ArithmeticException(&quot;Error&quot;);</span>
                    }
<span class="nc" id="L137">                });</span>
<span class="fc" id="L138">            }</span>
        });
<span class="fc" id="L140">    }</span>
    
    @ParameterizedTest(name = &quot;Threads = {0}&quot;)
    @ValueSource(ints = { 1, 2, 3, 5, 8, 12, 17, 29 })
    default void lifeCyclePromisor_ClaimsDuringClose(int threadCount) throws Throwable  {
<span class="fc" id="L145">        runWithScenario(new ScenarioConfig() {</span>
            @Override
            public int threadCount() {
<span class="fc" id="L148">                return threadCount;</span>
            }
            @Override
            public void mockupDeliverable(Decoy&lt;String&gt; mockDeliverable) {
<span class="fc" id="L152">                overrideClose(mockDeliverable, Duration.ofMillis(100), () -&gt; {});</span>
<span class="fc" id="L153">            }</span>
            @Override
            public void beforeWaitForCompletion(Promisor&lt;Decoy&lt;String&gt;&gt; testSubject) {
<span class="fc" id="L156">                sleep(Duration.ofMillis(100));</span>
<span class="fc" id="L157">                testSubject.decrementUsage();</span>
<span class="fc" id="L158">            }</span>
        });
<span class="fc" id="L160">    }</span>
    
    @ParameterizedTest(name = &quot;Threads = {0}&quot;)
    @ValueSource(ints = { 1, 2, 3, 5, 8, 12, 17, 29 })
    default void lifeCyclePromisor_ClaimsDuringDemand(int threadCount) throws Throwable {
<span class="fc" id="L165">        runWithScenario(new ScenarioConfig() {</span>
            @Override
            public int threadCount() {
<span class="fc" id="L168">                return threadCount;</span>
            }
            @Override
            public Duration demandDelay() {
<span class="fc" id="L172">                return Duration.ofMillis(100);</span>
            }
        });
<span class="fc" id="L175">    }</span>
    
    @Test
    default void lifecyclePromisor_InternalCoverage() {
<span class="fc" id="L179">        assertInstantiateThrows(ConcurrencyTestsTool.class);</span>
<span class="fc" id="L180">    }</span>
    
    final class ConcurrencyTestsTool {
<span class="fc" id="L183">        private ConcurrencyTestsTool() {</span>
<span class="fc" id="L184">            throw new AssertionError(&quot;Illegal constructor&quot;);</span>
        }
        
        interface ScenarioConfig {
            int threadCount();
            
            default void mockupDeliverable(Decoy&lt;String&gt; mockDeliverable) {
<span class="fc" id="L191">            }</span>
            
            default void beforeWaitForCompletion(Promisor&lt;Decoy&lt;String&gt;&gt; testSubject) {
<span class="fc" id="L194">            }</span>
            
            default Duration demandDelay() {
<span class="fc" id="L197">                return Duration.ZERO;</span>
            }
            
            @SuppressWarnings(&quot;SameReturnValue&quot;)
            default int claimsPerThread() {
<span class="fc" id="L202">                return 123;</span>
            }
            
            default float successPercentage() {
<span class="fc" id="L206">                return 1.0f;</span>
            }
        }
        
        static void runWithScenario(ScenarioConfig config) {
<span class="fc" id="L211">            final int totalClaims = config.threadCount()*config.claimsPerThread();</span>
<span class="fc" id="L212">            final int expectedSuccesses = (int)config.successPercentage()*totalClaims;</span>
<span class="fc" id="L213">            final int expectedFailures = totalClaims-expectedSuccesses;</span>
<span class="fc" id="L214">            final Contract&lt;Decoy&lt;String&gt;&gt; contract = Contract.create(&quot;Contract&quot;);</span>
<span class="fc" id="L215">            final Thread[] claimThreads = new Thread[config.threadCount()];</span>
<span class="fc" id="L216">            final AtomicInteger failedCount = new AtomicInteger(0);</span>
<span class="fc" id="L217">            final AtomicInteger successCount = new AtomicInteger(0);</span>
<span class="fc" id="L218">            final CountDownLatch latch = new CountDownLatch(config.threadCount());</span>
<span class="fc" id="L219">            @SuppressWarnings(&quot;resource&quot;) final Decoy&lt;String&gt; mockDeliverable = spy();</span>
<span class="fc" id="L220">            final Promisor&lt;Decoy&lt;String&gt;&gt; mockPromisor = spy();</span>
            
<span class="fc" id="L222">            withContracts( contracts -&gt; {</span>
<span class="fc" id="L223">                overrideDemand(mockPromisor, config.demandDelay(), () -&gt; mockDeliverable);</span>
<span class="fc" id="L224">                config.mockupDeliverable(mockDeliverable);</span>
                
<span class="fc" id="L226">                final Promisor&lt;Decoy&lt;String&gt;&gt; testSubject = createTestSubject(contracts, mockPromisor);</span>
                
<span class="fc" id="L228">                try (AutoClose closeBinding = contracts.bind(contract, testSubject)) {</span>
<span class="fc" id="L229">                    final AutoClose ignored2 = closeBinding;</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">                    for (int i = 0; i &lt; config.threadCount(); i++) {</span>
<span class="fc" id="L231">                        claimThreads[i] = new Thread(&quot;Claim-&quot; + i) {</span>
                            @Override
                            public void run() {
                                try {
<span class="fc bfc" id="L235" title="All 2 branches covered.">                                    for (int i = 0; i &lt; config.claimsPerThread(); i++) {</span>
                                        try {
                                            //noinspection resource
<span class="fc" id="L238">                                            contracts.claim(contract);</span>
<span class="fc" id="L239">                                            successCount.incrementAndGet();</span>
<span class="fc" id="L240">                                        } catch (Throwable thrown) {</span>
<span class="fc" id="L241">                                            failedCount.incrementAndGet();</span>
<span class="fc" id="L242">                                        }</span>
                                    }
                                } finally {
<span class="fc" id="L245">                                    latch.countDown();</span>
                                }
<span class="fc" id="L247">                            }</span>
                        };
                    }
<span class="fc bfc" id="L250" title="All 2 branches covered.">                    for (int i = 0; i &lt; config.threadCount(); i++) {</span>
<span class="fc" id="L251">                        claimThreads[i].start();</span>
                    }
<span class="fc" id="L253">                    config.beforeWaitForCompletion(testSubject);</span>
                    try {
<span class="fc" id="L255">                        assertTrue(latch.await(1, TimeUnit.MINUTES), &quot;Test took too long&quot;);</span>
<span class="nc" id="L256">                    } catch (InterruptedException e) {</span>
<span class="nc" id="L257">                        fail(&quot;Test took too long&quot;);</span>
<span class="fc" id="L258">                    }</span>
                }
                
<span class="fc" id="L261">                assertAll(</span>
<span class="fc" id="L262">                    () -&gt; assertEquals(expectedSuccesses, successCount.get(), &quot;Success count&quot;),</span>
<span class="fc" id="L263">                    () -&gt; assertEquals(expectedFailures, failedCount.get(), &quot;Failed count&quot;)</span>
                );
<span class="fc bfc" id="L265" title="All 2 branches covered.">                if (expectedSuccesses &gt; 0) {</span>
<span class="fc" id="L266">                    verify(mockDeliverable, times(1)).open();</span>
<span class="fc" id="L267">                    verify(mockDeliverable, times(1)).close();</span>
                }
<span class="fc" id="L269">            });</span>
<span class="fc" id="L270">        }</span>
        
        static &lt;T&gt; Promisor&lt;T&gt; createTestSubject(Contracts contracts, Promisor&lt;T&gt; promisor) {
<span class="fc" id="L273">            final Promisors promisors = contracts.claim(Promisors.CONTRACT);</span>
<span class="fc" id="L274">            return promisors.createLifeCyclePromisor(promisor);</span>
        }
   
        static &lt;T&gt; void overrideOpen(Decoy&lt;T&gt; decoy, Duration duration, Runnable block) {
<span class="fc" id="L278">            doAnswer((Answer&lt;AutoClose&gt;) invocation -&gt; {</span>
<span class="fc" id="L279">                sleep(duration);</span>
<span class="fc" id="L280">                block.run();</span>
<span class="fc" id="L281">                return decoy;</span>
<span class="fc" id="L282">            }).when(decoy).open();</span>
<span class="fc" id="L283">        }</span>
        
        static &lt;T&gt; void overrideClose(Decoy&lt;T&gt; decoy, Duration duration, Runnable block) {
<span class="fc" id="L286">            doAnswer((Answer&lt;Void&gt;) invocation -&gt; {</span>
<span class="fc" id="L287">                sleep(duration);</span>
<span class="fc" id="L288">                block.run();</span>
<span class="fc" id="L289">                return null; // Void methods return null in doAnswer</span>
<span class="fc" id="L290">            }).when(decoy).close();</span>
<span class="fc" id="L291">        }</span>
        
        static &lt;T&gt; void overrideDemand(Promisor&lt;T&gt; promisor, Duration duration, Supplier&lt;T&gt; block) {
<span class="fc" id="L294">            when(promisor.demand()).thenAnswer((Answer&lt;T&gt;) invocation -&gt; {</span>
<span class="fc" id="L295">                sleep(duration);</span>
<span class="fc" id="L296">                return block.get();</span>
            });
<span class="fc" id="L298">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>