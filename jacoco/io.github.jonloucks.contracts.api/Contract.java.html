<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Contract.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">contracts</a> &gt; <a href="index.source.html" class="el_package">io.github.jonloucks.contracts.api</a> &gt; <span class="el_source">Contract.java</span></div><h1>Contract.java</h1><pre class="source lang-java linenums">package io.github.jonloucks.contracts.api;

import java.util.concurrent.atomic.AtomicInteger;
import java.util.function.Consumer;

import static io.github.jonloucks.contracts.api.Checks.*;

/**
 * The API agreement for a Contract between the claimee and the claimant.
 * &lt;p&gt;
 * Each Contract instance is a unique key for establishing a binding between
 * an implementation and those that use it.
 * &lt;/p&gt;
 * &lt;ul&gt;
 *     &lt;li&gt;Create by custom config  {@link #create(Config)}&lt;/li&gt;
 *     &lt;li&gt;Creation by automatic config. {@link #create(String, Object[])}&lt;/li&gt;
 *     &lt;li&gt;Used by {@link GlobalContracts#claimContract(Contract)}&lt;/li&gt;
 *     &lt;li&gt;Used by {@link GlobalContracts#bindContract(Contract, Promisor)}&lt;/li&gt;
 *     &lt;li&gt;Used by {@link Contracts#claim(Contract)}&lt;/li&gt;
 *     &lt;li&gt;Used by {@link Contracts#bind(Contract, Promisor)}&lt;/li&gt;
 * &lt;/ul&gt;
 * &lt;h2&gt;A simple factory&lt;/h2&gt;
 * Each call to {@link Contracts#claim(Contract)} will return a new instance.
 * &lt;pre class=&quot;code&quot;&gt;
 *     &lt;code class=&quot;java&quot;&gt;
 *  // Save Contract at some agreed upon place
 *  public static final Contract&amp;lt;Contracts&amp;gt; SERVICE = Contract.create(&quot;You Choose&quot;);
 *  // The promisor needs to be bound before it is claimed.
 *  GlobalContracts.bindContract(SERVICE, () -&gt; new ServiceImpl());
 *  // Ready to be claimed
 *  Contracts service = GlobalContracts.claimContract(SERVICE);
 * &lt;/code&gt;&lt;/pre&gt;
 * If you need a thread specific
 *
 * @param &lt;T&gt; The type of deliverable
 */
public final class Contract&lt;T&gt; {
    
    /**
     * Create a contract with a given name, the rest is automatic.
     * For custom configuration see {@link #create(Config)}
     *
     * @param name          the name for the contract, null is not allowed
     * @param reifiedArray null is not allowed
     * @param &lt;T&gt;           the type of deliverable for this Contract
     * @return the new Contract
     */
    @SafeVarargs // Required to safely determine the checked type of T
    public static &lt;T&gt; Contract&lt;T&gt; create(String name, T... reifiedArray) {
<span class="fc" id="L50">        return create(detectDeliverableType(reifiedArray), b -&gt; b.name(name));</span>
    }
    
    /**
     * Create a contract with a given name, the rest is automatic.
     * For custom configuration see {@link #create(Config)}
     *
     * @param type          the deliverable class for the Contract
     * @param &lt;T&gt;           the type of deliverable for this Contract
     * @return the new Contract
     */
    public static &lt;T&gt; Contract&lt;T&gt; create(Class&lt;T&gt; type) {
<span class="fc" id="L62">        return create(type, b -&gt; {});</span>
    }
    
    /**
     * Create a contract derived from the given configuration
     *
     * @param config the name for the contract, null is not allowed
     * @param &lt;T&gt;    the type of deliverable for this Contract
     * @return the new Contract
     */
    public static &lt;T&gt; Contract&lt;T&gt; create(Config&lt;T&gt; config) {
<span class="fc" id="L73">        return new Contract&lt;&gt;(config);</span>
    }
    
    /**
     * Create a contract from a class type and an optional builder callback
     * @param type the type of deliverable for this Contract
     * @param builderConsumer the builder callback
     * @return the new Contract
     * @param &lt;T&gt; the type of deliverable for this Contract
     */
    public static &lt;T&gt; Contract&lt;T&gt; create(Class&lt;T&gt; type, Consumer&lt;Config.Builder&lt;T&gt;&gt; builderConsumer) {
<span class="fc" id="L84">        final ContractBuilderImpl&lt;T&gt; builder = new ContractBuilderImpl&lt;&gt;(typeCheck(type));</span>
<span class="fc" id="L85">        builderConsumerCheck(builderConsumer).accept(builder);</span>
<span class="fc" id="L86">        return create(builder);</span>
    }
    
    /**
     * Casts the given object to the return type for this Contract
     * This is used to make sure the value is a checked value and does not sneak passed during erasure
     *
     * @param value the value to cast
     * @return the checked value. Note: null is possible. The Promisor is allowed to return null
     * @throws ClassCastException iif the value can't be cast to the return type.
     */
    public T cast(Object value) {
<span class="fc" id="L98">        return config.cast(value);</span>
    }
    
    /**
     * @return the contract name
     */
    public String getName() {
<span class="fc" id="L105">        return config.name();</span>
    }
    
    /**
     * Note: Do not rely on this being a java class name
     * Note: The actual class is never exposed and is by design.
     *
     * @return the type of deliverable for this contract.
     */
    public String getTypeName() {
<span class="fc" id="L115">        return config.typeName();</span>
    }
    
    /**
     * When replaceable a new binding can replace in an existing one
     * The default is false
     *
     * @return true if replaceable
     */
    public boolean isReplaceable() {
<span class="fc" id="L125">        return config.isReplaceable();</span>
    }
    
    @Override
    public String toString() {
<span class="fc" id="L130">        return &quot;Contract[id=&quot; + id + &quot;, name=&quot; + getName() + &quot;, type=&quot; + getTypeName() + &quot;]&quot;;</span>
    }
    
    /**
     * The configuration for creating a custom Contract.
     * The required function is {@link Config#cast(Object)} which is plays
     * a key role in ensuring unchecked or unsafe instances do not escape
     *
     * @param &lt;T&gt; The Contract deliverable type
     */
    @FunctionalInterface
    public interface Config&lt;T&gt; {
        
        /**
         * Ensure an instance is of type T (or descendant)
         *
         * @param instance the value to cast to type T
         * @return the value, null is allowed
         * @throws ClassCastException when type of instance is not correct
         */
        T cast(Object instance);
        
        /**
         * User defined name for this contract.
         * Note: Do not rely on this being a java class name
         *
         * @return the type name
         */
        default String name() {
<span class="fc" id="L159">            return &quot;&quot;;</span>
        }
        
        /**
         * The type of deliverable for this contract.
         * Note: Do not rely on this being a java class name
         *
         * @return the type name, null is illegal
         */
        default String typeName() {
<span class="fc" id="L169">            return &quot;&quot;;</span>
        }
        
        /**
         * When replaceable a new binding can replace in an existing one
         * The default is false
         *
         * @return true if replaceable
         */
        default boolean isReplaceable() {
<span class="fc" id="L179">            return false;</span>
        }
        
        /**
         * Partial builder to streamline custom contracts
         * @param &lt;T&gt; The Contract deliverable type
         */
        interface Builder&lt;T&gt; extends Config&lt;T&gt; {
            /**
             * Set the Contract name
             * @param name the new name
             * @return this builder
             */
            Builder&lt;T&gt; name(String name);
            
            /**
             * Set the Contract typeName
             * @param typeName the new type name
             * @return this builder
             */
            Builder&lt;T&gt; typeName(String typeName);
            
            /**
             * Set if the Contract binding can be replaced
             * @param replaceable true allows a Contract binding to be replaced
             * @return this builder
             */
            Builder&lt;T&gt; replaceable(boolean replaceable);
        }
    }
    
<span class="fc" id="L210">    private static final AtomicInteger ID_GENERATOR = new AtomicInteger(1);</span>
    
<span class="fc" id="L212">    private final int id = ID_GENERATOR.getAndIncrement();</span>
    private final Config&lt;T&gt; config;
    
<span class="fc" id="L215">    private Contract(Config&lt;T&gt; config) {</span>
<span class="fc" id="L216">        this.config = configCheck(config);</span>
<span class="fc" id="L217">        nameCheck(config.name());</span>
<span class="fc" id="L218">        nullCheck(config.typeName(), &quot;Config type must be present.&quot;);</span>
<span class="fc" id="L219">    }</span>
    
    //Since arrays are reified the following is safe and checked
    @SuppressWarnings(&quot;unchecked&quot;)
    private static &lt;T&gt; Class&lt;T&gt; detectDeliverableType(T ... reifiedArray) {
<span class="fc" id="L224">        final T[] validReifiedArray = nullCheck(reifiedArray, &quot;Reified array must be present.&quot;);</span>
<span class="fc" id="L225">        return (Class&lt;T&gt;) validReifiedArray.getClass().getComponentType();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>